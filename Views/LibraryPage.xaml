<Page
    x:Class="NineLivesAudio.Views.LibraryPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:NineLivesAudio.Models"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    mc:Ignorable="d"
    Loaded="Page_Loaded">

    <Grid x:Name="LibraryRootGrid" Padding="{StaticResource PagePadding}">
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup x:Name="LibraryLayoutStates">
                <!-- Wide: > 900px — larger cards, more columns -->
                <VisualState x:Name="LibraryWideState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="900"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="BooksGridLayout.MinItemWidth" Value="180"/>
                        <Setter Target="SearchBox.MinWidth" Value="200"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Medium: 600–900px — standard grid -->
                <VisualState x:Name="LibraryMediumState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="600"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="BooksGridLayout.MinItemWidth" Value="160"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Narrow: < 600px — stacked controls, tighter spacing -->
                <VisualState x:Name="LibraryNarrowState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <!-- Tighter page padding -->
                        <Setter Target="LibraryRootGrid.Padding" Value="12,16,12,16"/>
                        <!-- Tighter grid -->
                        <Setter Target="BooksGridLayout.MinItemWidth" Value="130"/>
                        <Setter Target="BooksGridLayout.MinColumnSpacing" Value="8"/>
                        <Setter Target="BooksGridLayout.MinRowSpacing" Value="8"/>
                        <!-- Smaller combobox -->
                        <Setter Target="LibraryComboBox.MinWidth" Value="0"/>
                        <!-- Swap wide/narrow control rows -->
                        <Setter Target="ControlsRowWide.Visibility" Value="Collapsed"/>
                        <Setter Target="ControlsRowNarrow.Visibility" Value="Visible"/>
                        <!-- Tighter view mode buttons -->
                        <Setter Target="ViewModePanel.Spacing" Value="4"/>
                        <Setter Target="ViewModeAllButton.Padding" Value="10,5"/>
                        <Setter Target="ViewModeSeriesButton.Padding" Value="10,5"/>
                        <Setter Target="ViewModeAuthorButton.Padding" Value="10,5"/>
                        <Setter Target="ViewModeGenreButton.Padding" Value="10,5"/>
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Page Header -->
        <Grid Grid.Row="0" Margin="0,0,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBlock Text="Library" Style="{StaticResource PageTitleStyle}"/>

            <!-- Status Pill -->
            <Border x:Name="StatusPill" Grid.Column="1" Style="{StaticResource StatusPillStyle}"
                    Background="{StaticResource NebulaDarkBrush}">
                <StackPanel Orientation="Horizontal" Spacing="6">
                    <Ellipse x:Name="StatusEllipse" Width="6" Height="6" Fill="{StaticResource RitualSuccessBrush}"/>
                    <TextBlock x:Name="StatusText" Text="Connected" Style="{StaticResource StatusPillTextStyle}"
                               Foreground="{StaticResource MistBrush}"/>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Wide: Library Selector and Search (3-column row) -->
        <Grid x:Name="ControlsRowWide" Grid.Row="1" Margin="0,0,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Library Selector -->
            <ComboBox x:Name="LibraryComboBox"
                      Grid.Column="0"
                      MinWidth="180"
                      ItemsSource="{x:Bind ViewModel.Libraries}"
                      SelectedItem="{x:Bind ViewModel.SelectedLibrary, Mode=TwoWay}"
                      DisplayMemberPath="Name"
                      PlaceholderText="Select Library"/>

            <!-- Search Box -->
            <AutoSuggestBox x:Name="SearchBox"
                            Grid.Column="1"
                            Margin="12,0"
                            PlaceholderText="Search books..."
                            QueryIcon="Find"
                            Text="{x:Bind ViewModel.SearchQuery, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

            <!-- Refresh Button -->
            <Button Grid.Column="2"
                    Style="{StaticResource IconButtonStyle}"
                    Command="{x:Bind ViewModel.RefreshCommand}"
                    ToolTipService.ToolTip="Refresh library">
                <StackPanel>
                    <FontIcon Glyph="&#xE72C;" FontSize="16"/>
                </StackPanel>
            </Button>
        </Grid>

        <!-- Narrow: Library Selector and Search (stacked vertically) -->
        <StackPanel x:Name="ControlsRowNarrow" Grid.Row="1" Spacing="8" Margin="0,0,0,12"
                    Visibility="Collapsed">
            <!-- Row 1: ComboBox + Refresh -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <ComboBox x:Name="LibraryComboBoxNarrow"
                          Grid.Column="0"
                          HorizontalAlignment="Stretch"
                          ItemsSource="{x:Bind ViewModel.Libraries}"
                          SelectedItem="{x:Bind ViewModel.SelectedLibrary, Mode=TwoWay}"
                          DisplayMemberPath="Name"
                          PlaceholderText="Select Library"/>

                <Button Grid.Column="1"
                        Style="{StaticResource IconButtonStyle}"
                        Command="{x:Bind ViewModel.RefreshCommand}"
                        ToolTipService.ToolTip="Refresh library"
                        Margin="8,0,0,0">
                    <StackPanel>
                        <FontIcon Glyph="&#xE72C;" FontSize="16"/>
                    </StackPanel>
                </Button>
            </Grid>

            <!-- Row 2: Search box (full width) -->
            <AutoSuggestBox x:Name="SearchBoxNarrow"
                            HorizontalAlignment="Stretch"
                            PlaceholderText="Search books..."
                            QueryIcon="Find"
                            Text="{x:Bind ViewModel.SearchQuery, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
        </StackPanel>

        <!-- View Mode Buttons -->
        <StackPanel x:Name="ViewModePanel" Grid.Row="2" Orientation="Horizontal" Spacing="8" Margin="0,0,0,16">
            <Button Content="All" Click="ViewModeAll_Click" x:Name="ViewModeAllButton"
                    Style="{StaticResource CircularButtonStyle}" Width="Auto" Padding="16,8" CornerRadius="16"/>
            <Button Content="Series" Click="ViewModeSeries_Click" x:Name="ViewModeSeriesButton"
                    Style="{StaticResource CircularButtonStyle}" Width="Auto" Padding="16,8" CornerRadius="16"/>
            <Button Content="Authors" Click="ViewModeAuthor_Click" x:Name="ViewModeAuthorButton"
                    Style="{StaticResource CircularButtonStyle}" Width="Auto" Padding="16,8" CornerRadius="16"/>
            <Button Content="Genres" Click="ViewModeGenre_Click" x:Name="ViewModeGenreButton"
                    Style="{StaticResource CircularButtonStyle}" Width="Auto" Padding="16,8" CornerRadius="16"/>
        </StackPanel>

        <!-- Error State -->
        <Border Grid.Row="3"
                Visibility="{x:Bind ViewModel.HasError, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                Background="{StaticResource RitualErrorFaintBrush}"
                CornerRadius="{StaticResource RadiusMD}"
                Padding="16"
                Margin="0,0,0,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <FontIcon Glyph="&#xE7BA;" Foreground="{StaticResource RitualErrorBrush}" Margin="0,0,12,0"/>
                <TextBlock Grid.Column="1" Text="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"
                           TextWrapping="Wrap" VerticalAlignment="Center"
                           Foreground="{StaticResource MistBrush}"/>
            </Grid>
        </Border>

        <!-- Loading Indicator -->
        <Grid Grid.Row="5"
              Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="16">
                <ProgressRing IsActive="True" Width="48" Height="48"
                              Foreground="{StaticResource SigilGoldDimBrush}"/>
                <TextBlock Text="Loading library..." Style="{StaticResource SubtitleStyle}" HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>

        <!-- Main Content Area -->
        <Grid Grid.Row="5" x:Name="ContentArea"
              Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityInverseConverter}}">

            <!-- ALL: Audiobooks Grid -->
            <ScrollViewer x:Name="AllBooksView">
                <StackPanel>
                <!-- Sort + Hide Finished (only visible in All view) -->
                <StackPanel x:Name="SortFilterPanel" Orientation="Horizontal" Spacing="8"
                            HorizontalAlignment="Right" Margin="0,0,0,12">
                    <ToggleSwitch x:Name="HideFinishedToggle"
                                  Header="Hide Finished" OnContent="" OffContent=""
                                  Toggled="HideFinishedToggle_Toggled"
                                  MinWidth="0" Margin="0,-4,0,0"/>
                    <ComboBox x:Name="SortComboBox"
                              PlaceholderText="Sort" MinWidth="110"
                              SelectionChanged="SortComboBox_SelectionChanged">
                        <ComboBoxItem Content="Default" Tag="Default" IsSelected="True"/>
                        <ComboBoxItem Content="Title" Tag="Title"/>
                        <ComboBoxItem Content="Author" Tag="Author"/>
                        <ComboBoxItem Content="Progress" Tag="Progress"/>
                        <ComboBoxItem Content="Recent" Tag="RecentProgress"/>
                    </ComboBox>
                </StackPanel>
                <ItemsRepeater x:Name="BooksRepeater"
                               ItemsSource="{x:Bind ViewModel.FilteredAudioBooks}"
                               Margin="0,0,0,80">
                    <ItemsRepeater.Layout>
                        <UniformGridLayout x:Name="BooksGridLayout"
                                           MinItemWidth="160"
                                           MinRowSpacing="16"
                                           MinColumnSpacing="16"
                                           ItemsStretch="Fill"/>
                    </ItemsRepeater.Layout>
                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate x:DataType="models:AudioBook">
                            <Border Style="{StaticResource BookCardBorderStyle}"
                                    PointerPressed="BookCard_PointerPressed"
                                    PointerMoved="BookCard_PointerMoved"
                                    PointerReleased="BookCard_PointerReleased"
                                    PointerEntered="BookCard_PointerEntered"
                                    PointerExited="BookCard_PointerExited"
                                    Tag="{x:Bind}">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                <!-- Cover Image (square) -->
                                <controls:ConstrainedBox Grid.Row="0" AspectRatio="1:1">
                                    <Border Style="{StaticResource CoverImageBorderStyle}">
                                        <Grid>
                                            <FontIcon Glyph="&#xE8F1;"
                                                      FontSize="48"
                                                      Opacity="0.2"
                                                      HorizontalAlignment="Center"
                                                      VerticalAlignment="Center"/>
                                            <Image Source="{x:Bind CoverPath, Mode=OneWay, Converter={StaticResource StringToImageSourceConverter}}"
                                                   Stretch="UniformToFill"
                                                   ImageFailed="CoverImage_ImageFailed"/>
                                        </Grid>
                                    </Border>
                                </controls:ConstrainedBox>

                                <!-- Downloaded Badge -->
                                <Border Grid.Row="0"
                                        HorizontalAlignment="Right"
                                        VerticalAlignment="Top"
                                        Margin="4"
                                        Style="{StaticResource DownloadedBadgeStyle}"
                                        Visibility="{x:Bind IsDownloaded, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <FontIcon Glyph="&#xE73E;" FontSize="10"/>
                                        <TextBlock Text="Local" Style="{StaticResource BadgeTextStyle}"/>
                                    </StackPanel>
                                </Border>

                                <!-- Title -->
                                <TextBlock Grid.Row="1"
                                           Text="{x:Bind Title}"
                                           Style="{StaticResource CardTitleStyle}"
                                           Margin="0,8,0,2"/>

                                <!-- Author -->
                                <TextBlock Grid.Row="2"
                                           Text="{x:Bind Author}"
                                           Style="{StaticResource SubtitleStyle}"/>

                                <!-- Progress -->
                                <StackPanel Grid.Row="3" Spacing="4" Margin="0,6,0,0"
                                            Visibility="{x:Bind HasProgress, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <ProgressBar Value="{x:Bind ProgressPercent}"
                                                 Style="{StaticResource DownloadProgressStyle}"/>
                                    <TextBlock Text="{x:Bind ProgressText}"
                                               FontSize="11"
                                               Foreground="{StaticResource MistFaintBrush}"/>
                                </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>
                </StackPanel>
            </ScrollViewer>

            <!-- GROUPS: Series/Author/Genre Cards -->
            <ScrollViewer x:Name="GroupsView" Visibility="Collapsed">
                <ItemsRepeater x:Name="GroupsRepeater" Margin="0,0,0,80"
                               Loaded="GroupsRepeater_Loaded">
                    <ItemsRepeater.Layout>
                        <UniformGridLayout MinItemWidth="200"
                                           MinItemHeight="100"
                                           MinRowSpacing="12"
                                           MinColumnSpacing="12"
                                           ItemsStretch="Fill"/>
                    </ItemsRepeater.Layout>
                </ItemsRepeater>
            </ScrollViewer>

            <!-- GROUP DETAIL: Books in selected group -->
            <Grid x:Name="GroupDetailView" Visibility="Collapsed">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Back button and group title -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="12" Margin="0,0,0,16">
                    <Button Click="BackToGroups_Click" Style="{StaticResource IconButtonStyle}">
                        <FontIcon Glyph="&#xE72B;" FontSize="16"/>
                    </Button>
                    <TextBlock x:Name="GroupDetailTitle" Style="{StaticResource SectionTitleStyle}"
                               VerticalAlignment="Center" Margin="0"/>
                </StackPanel>

                <!-- Books in group -->
                <ScrollViewer Grid.Row="1">
                    <ItemsRepeater x:Name="GroupBooksRepeater" Margin="0,0,0,80">
                        <ItemsRepeater.Layout>
                            <UniformGridLayout MinItemWidth="160"
                                               MinItemHeight="260"
                                               MinRowSpacing="16"
                                               MinColumnSpacing="16"
                                               ItemsStretch="Fill"/>
                        </ItemsRepeater.Layout>
                    </ItemsRepeater>
                </ScrollViewer>
            </Grid>
        </Grid>

        <!-- Empty State -->
        <StackPanel Grid.Row="5"
                    Style="{StaticResource EmptyStateContainerStyle}"
                    Visibility="{x:Bind ViewModel.ShowEmptyState, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <FontIcon Glyph="&#xE8F1;" Style="{StaticResource EmptyStateIconStyle}"/>
            <TextBlock Text="{x:Bind ViewModel.EmptyStateTitle, Mode=OneWay}"
                       Style="{StaticResource EmptyStateTitleStyle}"/>
            <TextBlock Text="{x:Bind ViewModel.EmptyStateSubtitle, Mode=OneWay}"
                       Style="{StaticResource EmptyStateSubtitleStyle}"/>
            <Button Content="Refresh" Command="{x:Bind ViewModel.RefreshCommand}"
                    Style="{ThemeResource AccentButtonStyle}" Margin="0,16,0,0"/>
        </StackPanel>
    </Grid>
</Page>
