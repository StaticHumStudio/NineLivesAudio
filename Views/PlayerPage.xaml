<Page
    x:Class="NineLivesAudio.Views.PlayerPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Loaded="Page_Loaded"
    Unloaded="Page_Unloaded">

    <Grid x:Name="PlayerRootGrid" Padding="{StaticResource PagePadding}">
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup x:Name="PlayerLayoutStates">
                <!-- Wide: > 900px — generous spacing, large cover -->
                <VisualState x:Name="PlayerWideState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="900"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="PlayerContentStack.MaxWidth" Value="600"/>
                        <Setter Target="PlayerContentStack.Padding" Value="32"/>
                        <Setter Target="CoverArtBorder.Width" Value="320"/>
                        <Setter Target="CoverArtBorder.Height" Value="320"/>
                        <Setter Target="CoverArtBorder.Margin" Value="0,0,0,24"/>
                        <Setter Target="TitleText.FontSize" Value="28"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Medium: 600–900px — standard layout -->
                <VisualState x:Name="PlayerMediumState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="600"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="PlayerContentStack.MaxWidth" Value="500"/>
                        <Setter Target="PlayerContentStack.Padding" Value="20,16"/>
                        <Setter Target="CoverArtBorder.Width" Value="240"/>
                        <Setter Target="CoverArtBorder.Height" Value="240"/>
                        <Setter Target="CoverArtBorder.Margin" Value="0,0,0,16"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Narrow: < 600px — compact (base values, minimal overrides) -->
                <VisualState x:Name="PlayerNarrowState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="PlayerContentStack.MaxWidth" Value="400"/>
                        <Setter Target="TitleText.FontSize" Value="18"/>
                        <Setter Target="PlayerBackButtonLabel.Visibility" Value="Collapsed"/>
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Back Button + Pop-Out -->
        <Grid Grid.Row="0" Padding="8,4">
            <Button x:Name="PlayerBackButton" Click="BackButton_Click"
                    HorizontalAlignment="Left"
                    Background="Transparent" BorderThickness="0">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <FontIcon Glyph="&#xE72B;" FontSize="16" Foreground="{StaticResource MistFaintBrush}"/>
                    <TextBlock x:Name="PlayerBackButtonLabel" Text="Back" VerticalAlignment="Center"
                               Foreground="{StaticResource MistFaintBrush}"/>
                </StackPanel>
            </Button>

            <Button x:Name="PopOutButton" Click="PopOut_Click"
                    HorizontalAlignment="Right"
                    Background="Transparent" BorderThickness="0"
                    ToolTipService.ToolTip="Pop out mini player">
                <FontIcon Glyph="&#xE8A7;" FontSize="16"
                          Foreground="{StaticResource MistFaintBrush}"/>
            </Button>
        </Grid>

        <!-- No Book Playing State -->
        <StackPanel x:Name="EmptyStatePanel"
                    Grid.Row="1"
                    Style="{StaticResource EmptyStateContainerStyle}"
                    Visibility="Collapsed">
            <FontIcon Glyph="&#xE768;" Style="{StaticResource EmptyStateIconStyle}"/>
            <TextBlock Text="No audiobook playing"
                       Style="{StaticResource EmptyStateTitleStyle}"/>
            <TextBlock Text="Select a book from your library to start listening"
                       Style="{StaticResource EmptyStateSubtitleStyle}"/>
            <Button Content="Go to Library" Click="GoToLibrary_Click"
                    Style="{ThemeResource AccentButtonStyle}" Margin="0,16,0,0"/>
        </StackPanel>

        <!-- Player Content (compact-first base layout) -->
        <ScrollViewer x:Name="PlayerContent" Grid.Row="1" Visibility="Collapsed">
            <StackPanel x:Name="PlayerContentStack" Padding="12,8" HorizontalAlignment="Center">

                <!-- Cover Art (compact base: 160x160) -->
                <Border x:Name="CoverArtBorder"
                        Width="160"
                        Height="160"
                        CornerRadius="{StaticResource RadiusMD}"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,12"
                        Style="{StaticResource CoverImageBorderStyle}">
                    <Grid>
                        <FontIcon Glyph="&#xE8F1;" FontSize="64" Opacity="0.2"
                                  HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        <Image x:Name="CoverImage" Stretch="UniformToFill"/>
                    </Grid>
                </Border>

                <!-- Source Badge (Local/Streaming) -->
                <Border x:Name="SourceBadge"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,8"
                        Visibility="Collapsed"
                        Padding="12,6"
                        CornerRadius="{StaticResource RadiusSM}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <FontIcon x:Name="SourceBadgeIcon" FontSize="12"/>
                        <TextBlock x:Name="SourceBadgeText" Style="{StaticResource BadgeTextStyle}"/>
                    </StackPanel>
                </Border>

                <!-- Book Info -->
                <TextBlock x:Name="TitleText"
                           Style="{StaticResource PageTitleStyle}"
                           TextAlignment="Center"
                           HorizontalAlignment="Center"
                           MaxLines="2"
                           TextTrimming="CharacterEllipsis"/>

                <TextBlock x:Name="AuthorText"
                           Style="{StaticResource SubtitleStyle}"
                           TextAlignment="Center"
                           Margin="0,4,0,0"/>

                <!-- Series Info -->
                <TextBlock x:Name="SeriesText"
                           Style="{StaticResource CaptionStyle}"
                           TextAlignment="Center"
                           Margin="0,4,0,0"
                           Visibility="Collapsed"/>

                <!-- Track Indicator (multi-file) -->
                <TextBlock x:Name="TrackIndicator"
                           Style="{StaticResource CaptionStyle}"
                           TextAlignment="Center"
                           Margin="0,4,0,0"
                           Opacity="0.6"
                           Visibility="Collapsed"/>

                <!-- Chapter Name -->
                <TextBlock x:Name="ChapterNameText"
                           Style="{StaticResource CaptionStyle}"
                           TextAlignment="Center"
                           Margin="0,4,0,0"
                           Opacity="0.8"
                           TextTrimming="CharacterEllipsis"
                           MaxLines="1"
                           Visibility="Collapsed"/>

                <!-- Progress Slider -->
                <Grid Margin="0,12,0,0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <Slider x:Name="ProgressSlider"
                            Grid.Row="0"
                            Minimum="0"
                            Maximum="100"
                            ValueChanged="ProgressSlider_ValueChanged"/>

                    <Grid Grid.Row="1" Margin="0,4,0,0">
                        <TextBlock x:Name="CurrentTimeText"
                                   Style="{StaticResource CaptionStyle}"
                                   HorizontalAlignment="Left"/>
                        <TextBlock x:Name="RemainingTimeText"
                                   Style="{StaticResource CaptionStyle}"
                                   HorizontalAlignment="Right"/>
                    </Grid>
                </Grid>

                <!-- Chapter Mode Toggle (only visible when chapters exist) -->
                <StackPanel x:Name="ChapterModePanel"
                            Orientation="Horizontal"
                            HorizontalAlignment="Center"
                            Spacing="8"
                            Margin="0,4,0,0"
                            Visibility="Collapsed">
                    <TextBlock Text="Book"
                               Style="{StaticResource CaptionStyle}"
                               VerticalAlignment="Center"/>
                    <ToggleSwitch x:Name="ChapterModeToggle"
                                  OnContent="" OffContent=""
                                  Toggled="ChapterModeToggle_Toggled"
                                  MinWidth="40"/>
                    <TextBlock Text="Chapter"
                               Style="{StaticResource CaptionStyle}"
                               VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Playback Controls -->
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Center"
                            Spacing="12"
                            Margin="0,12,0,0">

                    <!-- Previous Chapter -->
                    <Button x:Name="PrevChapterButton"
                            Click="PrevChapter_Click"
                            Style="{StaticResource CircularButtonStyle}"
                            ToolTipService.ToolTip="Previous chapter"
                            Visibility="Collapsed">
                        <FontIcon Glyph="&#xE892;" FontSize="16"/>
                    </Button>

                    <!-- Skip Back 10s -->
                    <Button Click="SkipBack_Click"
                            Style="{StaticResource CircularButtonStyle}"
                            ToolTipService.ToolTip="Skip back 10 seconds">
                        <StackPanel>
                            <FontIcon Glyph="&#xE892;" FontSize="18"/>
                            <TextBlock Text="10" FontSize="10" HorizontalAlignment="Center" Opacity="0.7"/>
                        </StackPanel>
                    </Button>

                    <!-- Play/Pause -->
                    <Button x:Name="PlayPauseButton"
                            Click="PlayPause_Click"
                            Style="{StaticResource SigilPlayButtonStyle}">
                        <FontIcon x:Name="PlayPauseIcon" Glyph="&#xE768;" FontSize="28"
                                  Foreground="{StaticResource VoidDeepBrush}"/>
                    </Button>

                    <!-- Skip Forward 30s -->
                    <Button Click="SkipForward_Click"
                            Style="{StaticResource CircularButtonStyle}"
                            ToolTipService.ToolTip="Skip forward 30 seconds">
                        <StackPanel>
                            <FontIcon Glyph="&#xE893;" FontSize="18"/>
                            <TextBlock Text="30" FontSize="10" HorizontalAlignment="Center" Opacity="0.7"/>
                        </StackPanel>
                    </Button>

                    <!-- Next Chapter -->
                    <Button x:Name="NextChapterButton"
                            Click="NextChapter_Click"
                            Style="{StaticResource CircularButtonStyle}"
                            ToolTipService.ToolTip="Next chapter"
                            Visibility="Collapsed">
                        <FontIcon Glyph="&#xE893;" FontSize="16"/>
                    </Button>
                </StackPanel>

                <!-- Secondary Controls -->
                <Grid Margin="0,16,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition x:Name="ChaptersColumn" Width="0"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Playback Speed -->
                    <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                        <Button x:Name="SpeedButton" Click="SpeedButton_Click"
                                Style="{StaticResource IconButtonStyle}">
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <FontIcon Glyph="&#xEC57;" FontSize="16"/>
                                <TextBlock x:Name="SpeedText" Text="1.0x"
                                           Foreground="{StaticResource MistBrush}"/>
                            </StackPanel>
                        </Button>
                        <TextBlock Text="Speed" Style="{StaticResource CaptionStyle}"
                                   HorizontalAlignment="Center" Margin="0,4,0,0"/>
                    </StackPanel>

                    <!-- Sleep Timer -->
                    <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                        <Button x:Name="SleepButton" Click="SleepButton_Click"
                                Style="{StaticResource IconButtonStyle}">
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <FontIcon Glyph="&#xE708;" FontSize="16"/>
                                <TextBlock x:Name="SleepButtonText" Text="Off"
                                           Foreground="{StaticResource MistBrush}"/>
                            </StackPanel>
                        </Button>
                        <TextBlock Text="Sleep" Style="{StaticResource CaptionStyle}"
                                   HorizontalAlignment="Center" Margin="0,4,0,0"/>
                    </StackPanel>

                    <!-- Volume -->
                    <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                        <Button x:Name="VolumeButton" Style="{StaticResource IconButtonStyle}">
                            <Button.Flyout>
                                <Flyout>
                                    <StackPanel Width="200">
                                        <TextBlock Text="Volume" FontWeight="SemiBold" Margin="0,0,0,8"
                                                   Foreground="{StaticResource StarlightDimBrush}"/>
                                        <Slider x:Name="VolumeSlider"
                                                Minimum="0"
                                                Maximum="1"
                                                StepFrequency="0.05"
                                                ValueChanged="VolumeSlider_ValueChanged"/>
                                    </StackPanel>
                                </Flyout>
                            </Button.Flyout>
                            <FontIcon x:Name="VolumeIcon" Glyph="&#xE995;" FontSize="16"/>
                        </Button>
                        <TextBlock Text="Volume" Style="{StaticResource CaptionStyle}"
                                   HorizontalAlignment="Center" Margin="0,4,0,0"/>
                    </StackPanel>

                    <!-- Chapters -->
                    <StackPanel x:Name="ChaptersButtonPanel" Grid.Column="3" HorizontalAlignment="Center" Visibility="Collapsed">
                        <Button x:Name="ChaptersButton" Click="ChaptersButton_Click"
                                Style="{StaticResource IconButtonStyle}">
                            <FontIcon Glyph="&#xE8FD;" FontSize="16"/>
                        </Button>
                        <TextBlock Text="Chapters" Style="{StaticResource CaptionStyle}"
                                   HorizontalAlignment="Center" Margin="0,4,0,0"/>
                    </StackPanel>

                    <!-- Bookmarks -->
                    <StackPanel Grid.Column="4" HorizontalAlignment="Center">
                        <Button x:Name="BookmarkButton" Click="BookmarkButton_Click"
                                Style="{StaticResource IconButtonStyle}">
                            <FontIcon Glyph="&#xE8A4;" FontSize="16"/>
                        </Button>
                        <TextBlock Text="Bookmarks" Style="{StaticResource CaptionStyle}"
                                   HorizontalAlignment="Center" Margin="0,4,0,0"/>
                    </StackPanel>
                </Grid>

                <!-- Sleep Timer Status -->
                <Border x:Name="SleepTimerPanel"
                        Visibility="Collapsed"
                        Background="{StaticResource VoidSurfaceBrush}"
                        CornerRadius="{StaticResource RadiusSM}"
                        Padding="12"
                        Margin="0,12,0,0">
                    <Grid>
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE708;" FontSize="16"
                                      Foreground="{StaticResource SigilGoldDimBrush}"/>
                            <TextBlock x:Name="SleepTimerStatusText"
                                       Foreground="{StaticResource SigilGoldDimBrush}"/>
                        </StackPanel>
                        <Button HorizontalAlignment="Right"
                                Click="CancelSleepTimer_Click"
                                Content="Cancel"
                                Background="Transparent" BorderThickness="0"/>
                    </Grid>
                </Border>

            </StackPanel>
        </ScrollViewer>

        <!-- Loading Overlay -->
        <Grid x:Name="LoadingOverlay"
              Grid.Row="1"
              Background="{StaticResource VoidDeepBrush}"
              Visibility="Collapsed">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="16">
                <ProgressRing IsActive="True" Width="50" Height="50"
                              Foreground="{StaticResource SigilGoldDimBrush}"/>
                <TextBlock Text="Loading audiobook..." Style="{StaticResource SubtitleStyle}"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</Page>
