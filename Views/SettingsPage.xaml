<Page
    x:Class="NineLivesAudio.Views.SettingsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Loaded="Page_Loaded">

    <ScrollViewer>
        <StackPanel Padding="{StaticResource PagePadding}" Spacing="24" MaxWidth="600">

            <!-- Server Connection -->
            <StackPanel>
                <TextBlock Text="Server Connection"
                           Style="{StaticResource SectionTitleStyle}"
                           Margin="0,0,0,12"/>

                <Border Background="{StaticResource VoidSurfaceBrush}"
                        CornerRadius="8"
                        Padding="16"
                        BorderBrush="{StaticResource DustBrush}"
                        BorderThickness="1">
                    <StackPanel Spacing="16">

                        <!-- Connection Status -->
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Ellipse Width="12" Height="12"
                                     Fill="{x:Bind ConnectionStatusColor, Mode=OneWay}"/>
                            <TextBlock Text="{x:Bind ViewModel.ConnectionStatus, Mode=OneWay}"
                                       VerticalAlignment="Center"/>
                        </StackPanel>

                        <!-- Server URL -->
                        <TextBox Header="Server URL"
                                 PlaceholderText="https://audiobooks.example.com"
                                 Text="{x:Bind ViewModel.ServerUrl, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 IsEnabled="{x:Bind ViewModel.IsConnected, Mode=OneWay, Converter={StaticResource BoolToInverseConverter}}"/>

                        <!-- Username -->
                        <TextBox Header="Username"
                                 PlaceholderText="Enter your username"
                                 Text="{x:Bind ViewModel.Username, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 IsEnabled="{x:Bind ViewModel.IsConnected, Mode=OneWay, Converter={StaticResource BoolToInverseConverter}}"/>

                        <!-- Password -->
                        <PasswordBox Header="Password"
                                     PlaceholderText="Enter your password"
                                     Password="{x:Bind ViewModel.Password, Mode=TwoWay}"
                                     Visibility="{x:Bind ViewModel.IsConnected, Mode=OneWay, Converter={StaticResource BoolToVisibilityInverseConverter}}"/>

                        <!-- Connect/Disconnect Buttons -->
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button Content="Connect"
                                    Style="{ThemeResource AccentButtonStyle}"
                                    Background="{StaticResource SigilGoldBrush}"
                                    Foreground="{StaticResource VoidDeepBrush}"
                                    Command="{x:Bind ViewModel.ConnectCommand}"
                                    Visibility="{x:Bind ViewModel.IsConnected, Mode=OneWay, Converter={StaticResource BoolToVisibilityInverseConverter}}"
                                    IsEnabled="{x:Bind ViewModel.IsConnecting, Mode=OneWay, Converter={StaticResource BoolToInverseConverter}}"/>

                            <Button Content="Disconnect"
                                    Command="{x:Bind ViewModel.DisconnectCommand}"
                                    Visibility="{x:Bind ViewModel.IsConnected, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>

                            <Button Content="Test Connection"
                                    Command="{x:Bind ViewModel.TestConnectionCommand}"
                                    Visibility="{x:Bind ViewModel.IsConnected, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>

                            <ProgressRing IsActive="{x:Bind ViewModel.IsConnecting, Mode=OneWay}"
                                          Visibility="{x:Bind ViewModel.IsConnecting, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                          Width="24"
                                          Height="24"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Playback Settings -->
            <StackPanel>
                <TextBlock Text="Playback"
                           Style="{StaticResource SectionTitleStyle}"
                           Margin="0,0,0,12"/>

                <Border Background="{StaticResource VoidSurfaceBrush}"
                        CornerRadius="8"
                        Padding="16"
                        BorderBrush="{StaticResource DustBrush}"
                        BorderThickness="1">
                    <StackPanel Spacing="16">

                        <!-- Default Volume -->
                        <StackPanel>
                            <TextBlock Text="Default Volume" Margin="0,0,0,8"/>
                            <Slider Minimum="0"
                                    Maximum="1"
                                    StepFrequency="0.05"
                                    Value="{x:Bind ViewModel.Volume, Mode=TwoWay}"/>
                        </StackPanel>

                        <!-- Default Playback Speed -->
                        <ComboBox Header="Default Playback Speed"
                                  SelectedIndex="{x:Bind SpeedSelectedIndex, Mode=TwoWay}">
                            <ComboBoxItem Content="0.5x" Tag="0.5"/>
                            <ComboBoxItem Content="0.75x" Tag="0.75"/>
                            <ComboBoxItem Content="1.0x (Normal)" Tag="1.0"/>
                            <ComboBoxItem Content="1.25x" Tag="1.25"/>
                            <ComboBoxItem Content="1.5x" Tag="1.5"/>
                            <ComboBoxItem Content="1.75x" Tag="1.75"/>
                            <ComboBoxItem Content="2.0x" Tag="2.0"/>
                        </ComboBox>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Downloads Settings -->
            <StackPanel>
                <TextBlock Text="Downloads"
                           Style="{StaticResource SectionTitleStyle}"
                           Margin="0,0,0,12"/>

                <Border Background="{StaticResource VoidSurfaceBrush}"
                        CornerRadius="8"
                        Padding="16"
                        BorderBrush="{StaticResource DustBrush}"
                        BorderThickness="1">
                    <StackPanel Spacing="16">

                        <!-- Download Path -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Header="Download Location"
                                     Text="{x:Bind ViewModel.DownloadPath, Mode=TwoWay}"
                                     IsReadOnly="True"
                                     Grid.Column="0"/>
                            <Button Content="Browse"
                                    Click="BrowseButton_Click"
                                    VerticalAlignment="Bottom"
                                    Margin="8,0,0,0"
                                    Grid.Column="1"/>
                        </Grid>

                        <!-- Auto Download Covers -->
                        <ToggleSwitch Header="Auto-download cover art"
                                      IsOn="{x:Bind ViewModel.AutoDownloadCovers, Mode=TwoWay}"/>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Sync Settings -->
            <StackPanel>
                <TextBlock Text="Sync"
                           Style="{StaticResource SectionTitleStyle}"
                           Margin="0,0,0,12"/>

                <Border Background="{StaticResource VoidSurfaceBrush}"
                        CornerRadius="8"
                        Padding="16"
                        BorderBrush="{StaticResource DustBrush}"
                        BorderThickness="1">
                    <StackPanel Spacing="16">

                        <!-- Auto Sync Progress -->
                        <ToggleSwitch Header="Auto-sync playback progress"
                                      IsOn="{x:Bind ViewModel.AutoSyncProgress, Mode=TwoWay}"/>

                        <!-- Sync Interval -->
                        <ComboBox Header="Sync Interval"
                                  IsEnabled="{x:Bind ViewModel.AutoSyncProgress, Mode=OneWay}"
                                  SelectedIndex="{x:Bind SyncIntervalSelectedIndex, Mode=TwoWay}">
                            <ComboBoxItem Content="1 minute" Tag="1"/>
                            <ComboBoxItem Content="5 minutes" Tag="5"/>
                            <ComboBoxItem Content="10 minutes" Tag="10"/>
                            <ComboBoxItem Content="15 minutes" Tag="15"/>
                            <ComboBoxItem Content="30 minutes" Tag="30"/>
                        </ComboBox>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Appearance -->
            <StackPanel>
                <TextBlock Text="Appearance"
                           Style="{StaticResource SectionTitleStyle}"
                           Margin="0,0,0,12"/>

                <Border Background="{StaticResource VoidSurfaceBrush}"
                        CornerRadius="8"
                        Padding="16"
                        BorderBrush="{StaticResource DustBrush}"
                        BorderThickness="1">
                    <StackPanel Spacing="16">

                        <!-- Theme -->
                        <ComboBox Header="Theme"
                                  SelectedIndex="{x:Bind ThemeSelectedIndex, Mode=TwoWay}">
                            <ComboBoxItem Content="System default" Tag="System"/>
                            <ComboBoxItem Content="Light" Tag="Light"/>
                            <ComboBoxItem Content="Dark" Tag="Dark"/>
                        </ComboBox>

                        <!-- Start Minimized -->
                        <ToggleSwitch Header="Start minimized"
                                      IsOn="{x:Bind ViewModel.StartMinimized, Mode=TwoWay}"/>

                        <!-- Minimize to Tray -->
                        <ToggleSwitch Header="Minimize to system tray"
                                      IsOn="{x:Bind ViewModel.MinimizeToTray, Mode=TwoWay}"/>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Security -->
            <StackPanel>
                <TextBlock Text="Security"
                           Style="{StaticResource SectionTitleStyle}"
                           Margin="0,0,0,12"/>

                <Border Background="{StaticResource VoidSurfaceBrush}"
                        CornerRadius="8"
                        Padding="16"
                        BorderBrush="{StaticResource DustBrush}"
                        BorderThickness="1">
                    <StackPanel Spacing="16">

                        <ToggleSwitch Header="Allow self-signed SSL certificates"
                                      IsOn="{x:Bind ViewModel.AllowSelfSignedCertificates, Mode=TwoWay}"/>

                        <TextBlock Text="Only applies to your configured server host. Required for some self-hosted setups."
                                   TextWrapping="Wrap"
                                   Style="{StaticResource CaptionStyle}"/>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Data Management -->
            <StackPanel>
                <TextBlock Text="Data"
                           Style="{StaticResource SectionTitleStyle}"
                           Margin="0,0,0,12"/>

                <Border Background="{StaticResource VoidSurfaceBrush}"
                        CornerRadius="8"
                        Padding="16"
                        BorderBrush="{StaticResource DustBrush}"
                        BorderThickness="1">
                    <StackPanel Spacing="16">

                        <Button Content="Sync Now"
                                Command="{x:Bind ViewModel.ManualSyncCommand}"/>

                        <TextBlock Text="Rebuild local cache by syncing libraries, progress, and metadata from the server."
                                   TextWrapping="Wrap"
                                   Style="{StaticResource CaptionStyle}"/>

                        <Button Content="Clear Local Cache"
                                Command="{x:Bind ViewModel.ClearCacheCommand}"/>

                        <TextBlock Text="This will remove cached library data. Downloaded audiobooks will not be affected."
                                   TextWrapping="Wrap"
                                   Style="{StaticResource CaptionStyle}"/>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Diagnostics -->
            <StackPanel>
                <TextBlock Text="Diagnostics"
                           Style="{StaticResource SectionTitleStyle}"
                           Margin="0,0,0,12"/>

                <Border Background="{StaticResource VoidSurfaceBrush}"
                        CornerRadius="8"
                        Padding="16"
                        BorderBrush="{StaticResource DustBrush}"
                        BorderThickness="1">
                    <StackPanel Spacing="16">

                        <ToggleSwitch Header="Diagnostics mode"
                                      IsOn="{x:Bind ViewModel.DiagnosticsMode, Mode=TwoWay}"/>

                        <TextBlock Text="Enables verbose logging for API requests, state transitions, and playback events."
                                   TextWrapping="Wrap"
                                   Style="{StaticResource CaptionStyle}"/>

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button Content="Open Logs"
                                    Command="{x:Bind ViewModel.OpenLogFolderCommand}"/>

                            <Button Content="Export Logs"
                                    Command="{x:Bind ViewModel.ExportLogsCommand}"/>

                            <Button Content="Open Settings Folder"
                                    Command="{x:Bind ViewModel.OpenSettingsFolderCommand}"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Settings Doctor -->
            <StackPanel>
                <TextBlock Text="Settings Doctor"
                           Style="{StaticResource SectionTitleStyle}"
                           Margin="0,0,0,12"/>

                <Border Background="{StaticResource VoidSurfaceBrush}"
                        CornerRadius="8"
                        Padding="16"
                        BorderBrush="{StaticResource DustBrush}"
                        BorderThickness="1">
                    <StackPanel Spacing="12">

                        <Grid ColumnSpacing="12" RowSpacing="6">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Settings file:" Style="{StaticResource CaptionStyle}"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{x:Bind ViewModel.SettingsFilePath, Mode=OneWay}"
                                       FontSize="12" TextWrapping="WrapWholeWords" IsTextSelectionEnabled="True"
                                       Foreground="{StaticResource StarlightDimBrush}"/>

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Settings source:" Style="{StaticResource CaptionStyle}"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{x:Bind ViewModel.SettingsSource, Mode=OneWay}" FontSize="12"
                                       Foreground="{StaticResource StarlightDimBrush}"/>

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Token source:" Style="{StaticResource CaptionStyle}"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{x:Bind ViewModel.TokenSource, Mode=OneWay}" FontSize="12"
                                       Foreground="{StaticResource StarlightDimBrush}"/>

                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Last loaded:" Style="{StaticResource CaptionStyle}"/>
                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{x:Bind ViewModel.LastLoadedAt, Mode=OneWay}" FontSize="12"
                                       Foreground="{StaticResource StarlightDimBrush}"/>

                            <TextBlock Grid.Row="4" Grid.Column="0" Text="Session ID:" Style="{StaticResource CaptionStyle}"/>
                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{x:Bind ViewModel.SessionId, Mode=OneWay}"
                                       Style="{StaticResource MonoStyle}"/>

                            <TextBlock Grid.Row="5" Grid.Column="0" Text="Server host:" Style="{StaticResource CaptionStyle}"/>
                            <TextBlock Grid.Row="5" Grid.Column="1" Text="{x:Bind ViewModel.ServerHost, Mode=OneWay}" FontSize="12"
                                       Foreground="{StaticResource StarlightDimBrush}"/>
                        </Grid>

                        <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                            <Button Content="Test Connection"
                                    Command="{x:Bind ViewModel.TestConnectionCommand}"/>

                            <Button Content="Reset Connection"
                                    Command="{x:Bind ViewModel.ResetConnectionCommand}"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Save Button -->
            <Button Content="Save Settings"
                    Style="{ThemeResource AccentButtonStyle}"
                    Background="{StaticResource SigilGoldBrush}"
                    Foreground="{StaticResource VoidDeepBrush}"
                    Command="{x:Bind ViewModel.SaveSettingsCommand}"
                    HorizontalAlignment="Right"/>

            <!-- Messages -->
            <InfoBar x:Name="ErrorInfoBar"
                     IsOpen="{x:Bind ViewModel.HasError, Mode=OneWay}"
                     Severity="Error"
                     Title="Error"
                     Message="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"
                     IsClosable="True"
                     Closed="ErrorInfoBar_Closed"/>

            <InfoBar x:Name="SuccessInfoBar"
                     IsOpen="{x:Bind ViewModel.HasSuccess, Mode=OneWay}"
                     Severity="Success"
                     Title="Success"
                     Message="{x:Bind ViewModel.SuccessMessage, Mode=OneWay}"
                     IsClosable="True"
                     Closed="SuccessInfoBar_Closed"/>

            <!-- About Section -->
            <StackPanel Margin="0,16,0,32">
                <TextBlock Text="About"
                           Style="{StaticResource SectionTitleStyle}"
                           Margin="0,0,0,12"/>

                <Border Background="{StaticResource VoidSurfaceBrush}"
                        CornerRadius="8"
                        Padding="16"
                        BorderBrush="{StaticResource DustBrush}"
                        BorderThickness="1">
                    <StackPanel Spacing="8">
                        <TextBlock Text="Nine Lives Audio"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource StarlightDimBrush}"/>
                        <TextBlock Text="Version 1.0.0"
                                   Foreground="{StaticResource MistBrush}"/>
                        <TextBlock Text="A lightweight Windows client for Audiobookshelf"
                                   Foreground="{StaticResource MistFaintBrush}"
                                   TextWrapping="Wrap"/>
                        <Border Margin="0,8,0,0" Padding="0" Background="Transparent">
                            <StackPanel Spacing="4">
                                <TextBlock Text="This app is not affiliated with or endorsed by the Audiobookshelf project."
                                           Foreground="{StaticResource MistFaintBrush}"
                                           FontSize="11"
                                           TextWrapping="Wrap"
                                           Opacity="0.7"/>
                                <TextBlock Text="Audiobookshelf is open-source software licensed under GPL-3.0."
                                           Foreground="{StaticResource MistFaintBrush}"
                                           FontSize="11"
                                           TextWrapping="Wrap"
                                           Opacity="0.7"/>
                                <HyperlinkButton Content="audiobookshelf.org"
                                                 NavigateUri="https://www.audiobookshelf.org/"
                                                 FontSize="11"
                                                 Padding="0"
                                                 Foreground="{StaticResource SigilGoldDimBrush}"/>
                                <HyperlinkButton Content="Source Code on GitHub"
                                                 NavigateUri="https://github.com/jiffy1080/AudioBookshelfApp"
                                                 FontSize="11"
                                                 Padding="0"
                                                 Margin="0,4,0,0"
                                                 Foreground="{StaticResource SigilGoldDimBrush}"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Border>
            </StackPanel>

        </StackPanel>
    </ScrollViewer>
</Page>
